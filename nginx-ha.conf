# nginx-ha.conf - Load balancer configuration for Cedar HA deployment

# For gRPC load balancing
upstream grpc_backend {
    least_conn;
    server backend:50051;
}

server {
    listen 50051 http2;

    location / {
        grpc_pass grpc://grpc_backend;
    }
}

# Direct API access on port 8080 (for backward compatibility)
server {
    listen 8080;
    server_name localhost;

    # Use Docker's internal DNS resolver to handle scaled services
    resolver 127.0.0.11 valid=5s;

    set $backend_service "backend";

    location / {
        proxy_pass http://$backend_service:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE requires no buffering and long timeouts
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
        proxy_send_timeout 300s;
    }
}

# Web UI with API proxy on port 80 (accessible via WEB_PORT)
server {
    listen 80;
    server_name localhost;

    # Use Docker's internal DNS resolver to handle scaled services
    resolver 127.0.0.11 valid=5s;

    set $backend_service "backend";

    location /api/ {
        # Strip /api prefix - /api/v1/foo becomes /v1/foo on backend
        # Using rewrite because variables in proxy_pass don't do URI substitution
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://$backend_service:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE requires no buffering and long timeouts
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
        proxy_send_timeout 300s;
    }

    location /health {
        proxy_pass http://$backend_service:8080/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /v1/ {
        proxy_pass http://$backend_service:8080/v1/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE requires no buffering and long timeouts
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
        proxy_send_timeout 300s;
    }

    location / {
        set $web_service "web";
        proxy_pass http://$web_service:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
